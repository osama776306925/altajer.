<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªØ§Ø¬Ø± Ø´Ø§Øª</title>
    <style>
        /* style.css (Ù…Ø¯Ù…Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©) */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

        :root {
            --primary-color: #075e54;
            --secondary-color: #25d366;
            --background-light: #f0f2f5;
            --background-chat: #e5ddd5;
            --message-me: #dcf8c6;
            --message-other: #fff;
            --text-dark: #333;
            --text-light: #666;
            --border-color: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Cairo', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background-light);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: var(--text-dark);
            direction: rtl;
        }

        #app-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-light);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-light);
            padding: 25px;
            margin-bottom: 20px;
        }

        h2, h3, h4 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* Auth Section Styling */
        #auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        #auth-section label {
            align-self: flex-start;
            font-weight: 600;
            color: var(--text-dark);
        }

        #auth-section input[type="text"],
        #auth-section input[type="password"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            text-align: right;
            direction: rtl;
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }

        button {
            padding: 12px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s ease-in-out, transform 0.1s ease-in-out;
        }

        button:hover {
            background: #064d45;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #d9534f;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
        }

        .loading-indicator {
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            margin-top: 10px;
        }

        /* Chat Section Styling */
        #chat-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-header h2 {
            color: white;
            margin: 0;
        }

        .logout-btn {
            background: #dc3545;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .user-list-container {
            flex: 1;
            min-width: 250px;
            max-height: 500px;
            overflow-y: auto;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user {
            padding: 12px;
            background: var(--background-chat);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease-in-out, transform 0.1s ease-in-out;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user:hover {
            background: #dcdede;
            transform: translateX(5px);
        }

        .chat-area {
            flex: 3;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-width: 300px;
        }

        #chatBox {
            background: var(--background-chat);
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .message {
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px var(--shadow-light);
            font-size: 15px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .message-content {
            margin-bottom: 5px;
        }

        .message-info {
            font-size: 11px;
            color: var(--text-light);
            text-align: end;
            margin-top: 3px;
        }

        .me {
            background: var(--message-me);
            align-self: flex-end;
            margin-left: 25%;
        }

        .other {
            background: var(--message-other);
            align-self: flex-start;
            margin-right: 25%;
            border: 1px solid #eee;
        }

        /* Input area for messages */
        .input-area {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            background: #f9f9f9;
            text-align: right;
            direction: rtl;
        }

        #messageInput:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(7, 94, 84, 0.25);
        }

        .input-area button {
            background: var(--primary-color);
            border-radius: 25px;
            padding: 12px 20px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            #app-container {
                padding: 20px;
                max-width: 100%;
            }
            .main-content {
                flex-direction: column;
            }
            .user-list-container, .chat-area {
                min-width: unset;
                width: 100%;
            }
            .auth-buttons {
                flex-direction: column;
            }
            .auth-buttons button {
                width: 100%;
            }
            .message {
                max-width: 90%;
            }
            .me {
                margin-left: 10%;
            }
            .other {
                margin-right: 10%;
            }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <section id="auth-section" class="card">
            <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØªØ§Ø¬Ø± Ø´Ø§Øª ğŸ‘‹</h2>
            <p class="error-message" id="authErrorMessage"></p>

            <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
            <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username"><br>

            <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
            <input type="password" id="password" placeholder="********" autocomplete="new-password"><br>

            <div class="auth-buttons">
                <button id="signupButton">ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
                <button id="loginButton">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
            <p class="loading-indicator" id="authLoadingIndicator" style="display: none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
        </section>

        <section id="chat-section" style="display: none;">
            <div class="chat-header">
                <h2>Ø§Ù„ØªØ§Ø¬Ø± Ø´Ø§Øª</h2>
                <button id="logoutButton" class="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
            <h3 id="chatWith">Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>

            <div class="main-content">
                <div class="user-list-container card">
                    <h4>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªÙˆÙØ±ÙˆÙ†</h4>
                    <div class="user-list" id="usersList">
                        </div>
                </div>

                <div class="chat-area card">
                    <div id="chatBox" class="chat-box">
                        </div>

                    <div class="input-area">
                        <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
                        <button id="sendMessageButton">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        // app.js (Ù…Ø¯Ù…Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø©)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        // ØªÙ… Ø¥Ø¶Ø§ÙØ© 'where' Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Firestore Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        import { getFirestore, collection, doc, addDoc, query, orderBy, onSnapshot, getDocs, setDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Firebase Auth Ù‡Ù†Ø§ØŒ Ù„Ø£Ù†Ù†Ø§ Ù†Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹.

        // Ù„ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù…ÙƒØªØ¨Ø© Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­)
        // Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø¨Ù†ÙØ³ Ù‚ÙˆØ© bcrypt ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ Ù„ÙƒÙ†Ù‡ Ø£ÙØ¶Ù„ Ù…Ù† Ù„Ø§ Ø´ÙŠØ¡ Ù„ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        async function hashPassword(password) {
            const textEncoder = new TextEncoder();
            const data = textEncoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashedPassword;
        }

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCbQwZvbwWNte0IqrnGHABhQWwqgiRsLQ4", // **Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ**
            authDomain: "altajer-2fb23.firebaseapp.com", // **Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ**
            projectId: "altajer-2fb23", // **Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ**
            storageBucket: "altajer-2fb23.appspot.com",
            messagingSenderId: "387131983810",
            appId: "1:387131983810:web:aa7340482eed919701785b",
            measurementId: "G-EVZPV0GR74"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ø¹Ù†Ø§ØµØ± DOM Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const authSection = document.getElementById("auth-section");
        const chatSection = document.getElementById("chat-section");
        const authErrorMessage = document.getElementById("authErrorMessage");
        const authLoadingIndicator = document.getElementById("authLoadingIndicator");

        // Ø¹Ù†Ø§ØµØ± Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const signupButton = document.getElementById("signupButton");
        const loginButton = document.getElementById("loginButton");

        // Ø¹Ù†Ø§ØµØ± Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        const logoutButton = document.getElementById("logoutButton");
        const usersListElement = document.getElementById("usersList");
        const chatWithElement = document.getElementById("chatWith");
        const chatBoxElement = document.getElementById("chatBox");
        const messageInput = document.getElementById("messageInput");
        const sendMessageButton = document.getElementById("sendMessageButton");

        let currentChatUser = null;
        let unsubscribeFromChat = null;
        let currentUserId = null; // Ù„ØªØ®Ø²ÙŠÙ† UID Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

        // ===============================================
        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
        // ===============================================

        function showSection(sectionId) {
            authSection.style.display = "none";
            chatSection.style.display = "none";

            if (sectionId === "auth") {
                authSection.style.display = "flex";
                // Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡Ø§
                usernameInput.value = '';
                passwordInput.value = '';
                clearAuthError();
            } else if (sectionId === "chat") {
                chatSection.style.display = "flex";
                loadUsers();
            }
        }

        function displayAuthError(message) {
            authErrorMessage.textContent = message;
            authErrorMessage.style.display = "block";
        }

        function clearAuthError() {
            authErrorMessage.textContent = "";
            authErrorMessage.style.display = "none";
        }

        function setAuthLoading(isLoading) {
            if (isLoading) {
                authLoadingIndicator.style.display = "block";
                signupButton.disabled = true;
                loginButton.disabled = true;
            } else {
                authLoadingIndicator.style.display = "none";
                signupButton.disabled = false;
                loginButton.disabled = false;
            }
        }

        function setMessageInputState(isEnabled) {
            messageInput.disabled = !isEnabled;
            sendMessageButton.disabled = !isEnabled;
            if (isEnabled) {
                messageInput.focus();
            }
        }

        // ===============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ø¨Ù†Ø§Ø¡ ÙŠØ¯ÙˆÙŠ)
        // ===============================================

        async function handleSignup() {
            clearAuthError();
            setAuthLoading(true);

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                displayAuthError("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
                setAuthLoading(false);
                return;
            }
            if (username.length < 3) {
                displayAuthError("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
                setAuthLoading(false);
                return;
            }
            if (password.length < 6) {
                displayAuthError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
                setAuthLoading(false);
                return;
            }

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙØ±Ø§Ø¯Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    displayAuthError("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.");
                    setAuthLoading(false);
                    return;
                }

                const hashedPassword = await hashPassword(password);
                const newUserRef = doc(usersRef); // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù…Ø¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ (UID)
                const newUserId = newUserRef.id; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ UID Ø§Ù„Ø°ÙŠ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡

                await setDoc(newUserRef, {
                    uid: newUserId,
                    username: username,
                    passwordHash: hashedPassword,
                    createdAt: new Date()
                });

                currentUserId = newUserId;
                localStorage.setItem("uid", currentUserId); // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù€ UID ÙÙŠ localStorage
                showSection("chat");
            } catch (error) {
                console.error("Signup error:", error);
                displayAuthError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message);
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleLogin() {
            clearAuthError();
            setAuthLoading(true);

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                displayAuthError("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.");
                setAuthLoading(false);
                return;
            }

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    displayAuthError("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
                    setAuthLoading(false);
                    return;
                }

                const userData = querySnapshot.docs[0].data();
                const storedPasswordHash = userData.passwordHash;
                const enteredPasswordHash = await hashPassword(password);

                if (storedPasswordHash === enteredPasswordHash) {
                    currentUserId = userData.uid;
                    localStorage.setItem("uid", currentUserId);
                    showSection("chat");
                } else {
                    displayAuthError("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
                }
            } catch (error) {
                console.error("Login error:", error);
                displayAuthError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + error.message);
            } finally {
                setAuthLoading(false);
            }
        }

        async function handleLogout() {
            try {
                // Ù„Ø§ ÙŠÙˆØ¬Ø¯ signOut Ù…Ù† Firebase Auth Ù„Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§
                localStorage.removeItem("uid");
                currentUserId = null;
                showSection("auth");
                // Ù…Ø³Ø­ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆÙ‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                chatBoxElement.innerHTML = '';
                chatWithElement.textContent = "Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù…Ù‹Ø§ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©";
                usersListElement.innerHTML = ''; // Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                currentChatUser = null;
                if (unsubscribeFromChat) {
                    unsubscribeFromChat(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ÙØªÙˆØ­Ø©
                    unsubscribeFromChat = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±
                }
            } catch (error) {
                console.error("Error logging out:", error);
                alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: " + error.message);
            }
        }

        // ===============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        // ===============================================

        async function loadUsers() {
            try {
                const currentUserUid = localStorage.getItem("uid");
                if (!currentUserUid) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ UIDØŒ Ø¹Ø¯ Ø¥Ù„Ù‰ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                    showSection("auth");
                    return;
                }
                currentUserId = currentUserUid; // ØªØ­Ø¯ÙŠØ« UID Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ

                const usersRef = collection(db, "users");
                const querySnapshot = await getDocs(usersRef);
                usersListElement.innerHTML = "";

                querySnapshot.forEach(docu => {
                    const user = docu.data();
                    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ù„ÙŠØ³ Ù‡Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
                    if (user.uid !== currentUserUid) {
                        const div = document.createElement("div");
                        div.className = "user";
                        div.textContent = user.username; // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        div.dataset.userId = user.uid;
                        div.addEventListener("click", () => openChatWith(user));
                        usersListElement.appendChild(div);
                    }
                });
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
            }
        }

        function openChatWith(user) {
            if (unsubscribeFromChat) {
                unsubscribeFromChat(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£ÙŠ Ù…Ø­Ø§Ø¯Ø«Ø© Ø³Ø§Ø¨Ù‚Ø©
                unsubscribeFromChat = null; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±
            }

            currentChatUser = user;
            chatWithElement.textContent = `Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ ${user.username}`;
            chatBoxElement.innerHTML = "";
            setMessageInputState(true);

            const currentUserUid = localStorage.getItem("uid");
            // Ø¨Ù†Ø§Ø¡ chatId ÙØ±ÙŠØ¯ ÙˆÙ…Ø³ØªÙ‚Ø± Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const chatId = currentUserUid < user.uid ? `${currentUserUid}_${user.uid}` : `${user.uid}_${currentUserUid}`;
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(messagesRef, orderBy("createdAt"));

            unsubscribeFromChat = onSnapshot(q, (snapshot) => {
                chatBoxElement.innerHTML = "";
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const msg = document.createElement("div");
                    msg.className = `message ${data.sender === currentUserUid ? "me" : "other"}`;

                    const timestamp = data.createdAt ? new Date(data.createdAt.toDate()) : new Date();
                    const timeString = timestamp.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });

                    msg.innerHTML = `
                        <div class="message-content">${data.text}</div>
                        <div class="message-info">
                            <span class="message-time">${timeString}</span>
                        </div>
                    `;
                    chatBoxElement.appendChild(msg);
                });
                chatBoxElement.scrollTop = chatBoxElement.scrollHeight;
            }, (error) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„:", error);
            });
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChatUser) {
                return;
            }

            const currentUserUid = localStorage.getItem("uid");
            if (!currentUserUid) {
                handleLogout(); // ÙÙŠ Ø­Ø§Ù„ ÙÙ‚Ø¯Ø§Ù† UID Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ Ù‚Ù… Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                return;
            }

            messageInput.value = "";
            setMessageInputState(false); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„

            try {
                const chatId = currentUserUid < currentChatUser.uid ? `${currentUserUid}_${currentChatUser.uid}` : `${currentChatUser.uid}_${currentUserUid}`;
                const messagesRef = collection(db, "chats", chatId, "messages");

                await addDoc(messagesRef, {
                    text: text,
                    sender: currentUserUid,
                    receiver: currentChatUser.uid,
                    createdAt: new Date()
                });
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error);
                alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: " + error.message);
            } finally {
                setMessageInputState(true); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            }
        }

        // ===============================================
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        // ===============================================

        // Ù‡Ø°Ø§ ÙŠØ³ØªØ¨Ø¯Ù„ onAuthStateChanged Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Firebase Auth
        document.addEventListener("DOMContentLoaded", () => {
            const storedUid = localStorage.getItem("uid");
            if (storedUid) {
                currentUserId = storedUid;
                showSection("chat");
                setMessageInputState(false); // ØªØ¹Ø·ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
            } else {
                showSection("auth");
            }
        });

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        signupButton.addEventListener("click", handleSignup);
        loginButton.addEventListener("click", handleLogin);
        logoutButton.addEventListener("click", handleLogout);
        sendMessageButton.addEventListener("click", sendMessage);

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        messageInput.addEventListener("keypress", (e) => {
            if (e.key === 'Enter' && !sendMessageButton.disabled) {
                sendMessage();
            }
        });
    </script>
</body>
</html>